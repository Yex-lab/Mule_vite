import{r,aT as Z,j as o,aU as W,aV as _,aW as G,a9 as Y,aX as J,B as q,aY as O,m as A,T as ee,aZ as X,a_ as te,a$ as Q,b0 as B,b1 as D,u as ie,c as se,b2 as ne,p as H,b3 as L}from"./index-DzR_SryQ.js";import{S as re,H as oe,B as V}from"./morphing-shapes-ko488LP2.js";import{C as ae,H as ce}from"./liquid-effects-C9SRvykV.js";import{i as le,u as ue}from"./use-presence-BIOmTntf.js";import{A as fe}from"./app-logo-CedKPsNT.js";import{o as U}from"./organization.slice-Cf40ymyD.js";import"./visual-element-ssD_hB3Y.js";function K(e,i){if(typeof e=="function")return e(i);e!=null&&(e.current=i)}function de(...e){return i=>{let t=!1;const n=e.map(a=>{const s=K(a,i);return!t&&typeof s=="function"&&(t=!0),s});if(t)return()=>{for(let a=0;a<n.length;a++){const s=n[a];typeof s=="function"?s():K(e[a],null)}}}}function pe(...e){return r.useCallback(de(...e),e)}class he extends r.Component{getSnapshotBeforeUpdate(i){const t=this.props.childRef.current;if(t&&i.isPresent&&!this.props.isPresent){const n=t.offsetParent,a=le(n)&&n.offsetWidth||0,s=this.props.sizeRef.current;s.height=t.offsetHeight||0,s.width=t.offsetWidth||0,s.top=t.offsetTop,s.left=t.offsetLeft,s.right=a-s.width-s.left}return null}componentDidUpdate(){}render(){return this.props.children}}function me({children:e,isPresent:i,anchorX:t,root:n}){const a=r.useId(),s=r.useRef(null),R=r.useRef({width:0,height:0,top:0,left:0,right:0}),{nonce:b}=r.useContext(Z),T=pe(s,e?.ref);return r.useInsertionEffect(()=>{const{width:u,height:w,top:f,left:g,right:C}=R.current;if(i||!s.current||!u||!w)return;const E=t==="left"?`left: ${g}`:`right: ${C}`;s.current.dataset.motionPopId=a;const c=document.createElement("style");b&&(c.nonce=b);const z=n??document.head;return z.appendChild(c),c.sheet&&c.sheet.insertRule(`
          [data-motion-pop-id="${a}"] {
            position: absolute !important;
            width: ${u}px !important;
            height: ${w}px !important;
            ${E}px !important;
            top: ${f}px !important;
          }
        `),()=>{z.contains(c)&&z.removeChild(c)}},[i]),o.jsx(he,{isPresent:i,childRef:s,sizeRef:R,children:r.cloneElement(e,{ref:T})})}const ge=({children:e,initial:i,isPresent:t,onExitComplete:n,custom:a,presenceAffectsLayout:s,mode:R,anchorX:b,root:T})=>{const u=W(ye),w=r.useId();let f=!0,g=r.useMemo(()=>(f=!1,{id:w,initial:i,isPresent:t,custom:a,onExitComplete:C=>{u.set(C,!0);for(const E of u.values())if(!E)return;n&&n()},register:C=>(u.set(C,!1),()=>u.delete(C))}),[t,u,n]);return s&&f&&(g={...g}),r.useMemo(()=>{u.forEach((C,E)=>u.set(E,!1))},[t]),r.useEffect(()=>{!t&&!u.size&&n&&n()},[t]),R==="popLayout"&&(e=o.jsx(me,{isPresent:t,anchorX:b,root:T,children:e})),o.jsx(_.Provider,{value:g,children:e})};function ye(){return new Map}const F=e=>e.key||"";function N(e){const i=[];return r.Children.forEach(e,t=>{r.isValidElement(t)&&i.push(t)}),i}const xe=({children:e,custom:i,initial:t=!0,onExitComplete:n,presenceAffectsLayout:a=!0,mode:s="sync",propagate:R=!1,anchorX:b="left",root:T})=>{const[u,w]=ue(R),f=r.useMemo(()=>N(e),[e]),g=R&&!u?[]:f.map(F),C=r.useRef(!0),E=r.useRef(f),c=W(()=>new Map),[z,S]=r.useState(f),[m,P]=r.useState(f);G(()=>{C.current=!1,E.current=f;for(let y=0;y<m.length;y++){const d=F(m[y]);g.includes(d)?c.delete(d):c.get(d)!==!0&&c.set(d,!1)}},[m,g.length,g.join("-")]);const j=[];if(f!==z){let y=[...f];for(let d=0;d<m.length;d++){const I=m[d],x=F(I);g.includes(x)||(y.splice(d,0,I),j.push(I))}return s==="wait"&&j.length&&(y=j),P(N(y)),S(f),null}const{forceRender:$}=r.useContext(Y);return o.jsx(o.Fragment,{children:m.map(y=>{const d=F(y),I=R&&!u?!1:f===m||g.includes(d),x=()=>{if(c.has(d))c.set(d,!0);else return;let l=!0;c.forEach(k=>{k||(l=!1)}),l&&($?.(),P(E.current),R&&w?.(),n&&n())};return o.jsx(ge,{isPresent:I,initial:!C.current||t?void 0:!1,custom:i,presenceAffectsLayout:a,mode:s,root:T,onExitComplete:I?void 0:x,anchorX:b,children:y},d)})})};function Ce({services:e,onPreInitialize:i,onValidate:t,onSuccess:n,onError:a,logo:s,messageInterval:R=1500,backgroundAnimations:b,errorDisplay:T="service",failureMode:u="all",redirectDelay:w=1e3,initTimeout:f=3e4,failedText:g="Initialization Failed",retryText:C="Retry",failedServicesSummary:E=c=>`Failed to load ${c} service${c>1?"s":""}`}){const[c,z]=r.useState(0),[S,m]=r.useState(!1),P=r.useRef(!1),j=r.useRef(void 0),$=J(x=>x.addNotification),y=e.map(x=>x.message),d=async()=>{if(P.current)return;if(P.current=!0,m(!1),j.current=setTimeout(()=>{const h={service:"timeout",error:`Initialization timed out after ${f}ms`,critical:!0};m(!0),a([h]),P.current=!1},f),i)try{if(!await i()){const v={service:"pre-initialization",error:"Pre-initialization check failed",critical:!0};m(!0),a([v]);return}}catch(h){const v={service:"pre-initialization",error:h?.message||"Pre-initialization error",critical:!0};m(!0),a([v]);return}const x=await Promise.allSettled(e.map(h=>h.fn())),l=[],k=[];if(x.forEach((h,v)=>{const p=e[v];if(h.status==="fulfilled")p.setter(h.value),k.push({service:p.name,data:h.value});else{const M={service:p.name,error:h.reason?.message||"Unknown error",critical:p.critical};l.push(M)}}),t&&l.length===0)try{if(!await t(k)){const v={service:"validation",error:"Service data validation failed",critical:!0};l.push(v)}}catch(h){const v={service:"validation",error:h?.message||"Validation error",critical:!0};l.push(v)}if(l.length>0){if(j.current&&clearTimeout(j.current),T==="service")l.forEach(p=>{$({id:`init-error-${p.service}-${Date.now()}`,type:p.critical?"error":"warning",message:`${p.service}: ${p.error}`,duration:p.critical?0:5e3,persist:p.critical})});else{const p=l.some(M=>M.critical);$({id:`init-error-summary-${Date.now()}`,type:p?"error":"warning",message:E(l.length),duration:p?0:5e3,persist:p})}const h=l.some(p=>p.critical),v=u==="all"||u==="critical"&&h;v&&m(!0),a(l),v||setTimeout(n,w)}else j.current&&clearTimeout(j.current),setTimeout(n,w)};r.useEffect(()=>{const x=setInterval(()=>{z(l=>(l+1)%y.length)},R);return d(),()=>{clearInterval(x),j.current&&clearTimeout(j.current)}},[]);const I=()=>{P.current=!1,m(!1),z(0),d()};return o.jsxs(q,{sx:{position:"relative",minHeight:"100vh",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",overflow:"hidden",bgcolor:"background.default"},children:[b,o.jsxs(q,{sx:{position:"relative",zIndex:1,textAlign:"center"},children:[o.jsx(O,{logo:s}),o.jsx(xe,{mode:"wait",children:o.jsx(A.div,{initial:"hidden",animate:"visible",exit:"exit",style:{marginTop:32},children:o.jsx(ee,{variant:"h6",sx:{color:"text.primary"},component:"div",children:(S?g:y[c]).split(" ").map((x,l)=>o.jsx(A.span,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},transition:{duration:.3,delay:l*.1},style:{display:"inline-block",marginRight:"0.25em"},children:x},l))})},S?"failed":c)}),S&&o.jsx(ae,{onClick:I,sx:{mt:3},children:C})]})]})}const ve=(e,i)=>{const t=X.getState();return[{name:"userProfile",fn:()=>te.getUser(e),setter:n=>{t.setAppConfig({...t.appConfig,currentUser:n})},critical:!0,message:"Loading your profile..."},{name:"organization",fn:()=>i.fetchQuery({queryKey:["organization"],queryFn:U.queryFn,staleTime:U.staleTime}),setter:()=>{},critical:!0,message:"Loading organization data..."},{name:"accounts",fn:()=>i.fetchQuery({queryKey:["accounts"],queryFn:Q.queryFn,staleTime:Q.staleTime}),setter:n=>{t.slices.accounts.setData(n)},critical:!1,message:"Loading accounts..."},{name:"contacts",fn:()=>i.fetchQuery({queryKey:["contacts"],queryFn:B.queryFn,staleTime:B.staleTime}),setter:n=>{t.slices.contacts.setData(n)},critical:!1,message:"Loading contacts..."},{name:"submissions",fn:()=>i.fetchQuery({queryKey:["submissions"],queryFn:D.queryFn,staleTime:D.staleTime}),setter:n=>{t.slices.submissions.setData(n)},critical:!1,message:"Loading submissions..."}]};function Te(){const e=ie(),{user:i}=se(),t=ne(),n=X(s=>s.setInitialized),a=r.useMemo(()=>i?.id?ve(i.id,t):[],[i?.id,t]);return r.useEffect(()=>{i?.id||e.push(H.auth.supabase.signIn)},[e,i]),i?.id?o.jsx(Ce,{services:a,redirectDelay:1500,onPreInitialize:()=>(L.info("Pre-initialization check"),!0),onValidate:s=>i?(L.info("Validation passed:",{userId:i.id,results:s}),!0):(L.error("Validation failed: User not found in state"),!1),onSuccess:()=>{n(!0),e.push(H.dashboard.root)},onError:s=>{L.error("Initialization failed:",s),n(!1)},logo:o.jsx(fe,{width:64,height:64}),backgroundAnimations:o.jsxs(o.Fragment,{children:[o.jsx(re,{sx:{position:"absolute",width:"100%",height:"100%",opacity:.3,mixBlendMode:"screen"}}),o.jsx(ce,{}),o.jsx(oe,{sx:{position:"absolute",top:"20%",right:"10%"}}),o.jsx(V,{sx:{position:"absolute",top:"20%",right:"50%"}}),o.jsx(V,{sx:{position:"absolute",top:"50%",left:"10%"}})]})}):null}export{Te as default};
