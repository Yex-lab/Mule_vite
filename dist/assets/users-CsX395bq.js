import{r as x,at as B,bB as $,j as e,au as Q,av as q,aw as H,bC as G,ax as J,bD as K,b as F,bE as X,bk as Y,S as A,bF as Z,T as j,bG as R,B as g,aB as ee,I as u,bH as se,bI as v,bJ as U,u as ae,bp as re,bd as te,b3 as h,bK as D,bL as ie,a_ as ne}from"./index-DzR_SryQ.js";import{E as oe,u as le}from"./enhanced-form-builder-CrQiAVKc.js";import{A as de,D as ce}from"./actions-cell-D2uG9A6N.js";import{A as me}from"./avatar-name-cell-6NGxl_zJ.js";import{C as T,D as ue}from"./date-cell-CyLLe_kF.js";import{P as pe}from"./page-header-CS2V_FKh.js";import{u as M}from"./use-translation-Bij3JYAK.js";import{a as xe,b as fe,u as he,c as be}from"./user-add.form-C3IzXE3u.js";import{f as V}from"./format-time-K3LaRyBo.js";import"./index-C6uWFXOn.js";import"./FormControlLabel-WwFoKCbJ.js";import"./Tabs-BwSGSZfk.js";import"./Breadcrumbs-CpfBRh9G.js";const je=a=>{const{alignItems:t,classes:n}=a;return H({root:["root",t==="flex-start"&&"alignItemsFlexStart"]},G,n)},ge=Q("div",{name:"MuiListItemIcon",slot:"Root",overridesResolver:(a,t)=>{const{ownerState:n}=a;return[t.root,n.alignItems==="flex-start"&&t.alignItemsFlexStart]}})(J(({theme:a})=>({minWidth:56,color:(a.vars||a).palette.action.active,flexShrink:0,display:"inline-flex",variants:[{props:{alignItems:"flex-start"},style:{marginTop:8}}]}))),S=x.forwardRef(function(t,n){const d=B({props:t,name:"MuiListItemIcon"}),{className:o,...l}=d,p=x.useContext($),f={...d,alignItems:p.alignItems},b=je(f);return e.jsx(ge,{className:q(b.root,o),ownerState:f,ref:n,...l})});function P({open:a,onClose:t,title:n,description:d,store:o,rows:l,mode:p,entityId:f,defaultValues:b,onSuccess:I,maxWidth:m="md",submitLabel:i,cancelLabel:c="Cancel"}){const w=()=>{I?.(),t()};return e.jsx(K,{open:a,onClose:t,title:n,description:d,maxWidth:m,actions:e.jsxs(e.Fragment,{children:[e.jsx(F,{onClick:t,variant:"outlined",color:"inherit",children:c}),e.jsx(F,{type:"submit",form:"enhanced-form",variant:"contained",color:"inherit",children:i||(p==="create"?"Create":"Save")})]}),children:e.jsx(oe,{rows:l,store:o,mode:p,entityId:f,defaultValues:b,hideSubmitButton:!0,onSuccess:w})})}function we({checked:a,onChange:t,disabled:n=!1,size:d="small",color:o="primary"}){return e.jsx(X,{checked:a,onChange:l=>{l.stopPropagation(),t(l.target.checked)},disabled:n,size:d,color:o})}function ye({open:a,onClose:t,onSuccess:n}){const d="create",o=x.useMemo(()=>"Add New User",[]),l=x.useMemo(()=>"Create a new user account with profile information. If no password is provided, the user will receive a magic link to set their password.",[]);return e.jsx(P,{open:a,onClose:t,title:o,description:l,store:fe,rows:xe,mode:d,entityId:void 0,defaultValues:void 0,maxWidth:"sm",submitLabel:"Create User",cancelLabel:"Cancel",onSuccess:n})}function ve({open:a,onClose:t,user:n,onSuccess:d}){const{t:o}=M(),l=n?.id?"update":"create",p=x.useMemo(()=>o(l==="create"?"userForm.addTitle":"userForm.editTitle"),[l,o]),f=x.useMemo(()=>o(l==="create"?"userForm.createDesc":"userForm.updateDesc"),[l,o]);return e.jsx(P,{open:a,onClose:t,title:p,description:f,store:be,rows:he,mode:l,entityId:n?.id,defaultValues:n??void 0,maxWidth:"sm",submitLabel:o(l==="create"?"userForm.create":"userForm.save"),cancelLabel:o("userForm.cancel"),onSuccess:d})}function Ue({open:a,onClose:t,user:n,onEdit:d,onViewProfile:o,onSuspend:l,onResetPassword:p,onResendInvite:f,onDelete:b,animation:I="flyout"}){const[m,i]=x.useState(!0);if(!n)return null;const{supabaseUser:c,profile:w}=n,_=w?.displayName??(`${w?.firstName??""} ${w?.lastName??""}`.trim()||c?.email?.split("@")[0])??"Unknown",k=c?.user_metadata?.banned??!1,C=!!c?.email_confirmed_at;return e.jsx(Y,{open:a,onClose:t,anchor:"right",slotProps:{backdrop:{invisible:I==="flyout"},paper:{sx:{width:360}}},children:e.jsxs(A,{spacing:3,sx:{p:3},children:[e.jsxs(A,{alignItems:"center",spacing:2,children:[e.jsx(Z,{sx:{width:96,height:96,fontSize:"2rem"},children:_.charAt(0).toUpperCase()}),e.jsxs(A,{alignItems:"center",spacing:.5,children:[e.jsx(j,{variant:"h6",children:_}),e.jsx(j,{variant:"body2",color:"text.secondary",children:c?.email})]})]}),e.jsx(R,{}),e.jsxs(g,{children:[e.jsxs(g,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",px:1,mb:1,cursor:"pointer"},onClick:()=>i(!m),children:[e.jsx(j,{variant:"overline",sx:{color:"text.secondary"},children:"Quick Actions"}),e.jsx(ee,{size:"small",sx:{p:0},children:e.jsx(u,{icon:m?"solar:alt-arrow-up-bold":"solar:alt-arrow-down-bold",width:16})})]}),e.jsxs(se,{in:m,children:[e.jsxs(v,{onClick:d,sx:{py:.5,px:1},children:[e.jsx(S,{sx:{minWidth:32},children:e.jsx(u,{icon:"solar:pen-bold",width:20})}),e.jsx(U,{primary:"Edit User",sx:{"& .MuiListItemText-primary":{color:"text.secondary",fontSize:"0.875rem"}}})]}),e.jsxs(v,{onClick:o,sx:{py:.5,px:1},children:[e.jsx(S,{sx:{minWidth:32},children:e.jsx(u,{icon:"solar:eye-bold",width:20})}),e.jsx(U,{primary:"View Full Profile",sx:{"& .MuiListItemText-primary":{color:"text.secondary",fontSize:"0.875rem"}}})]}),e.jsxs(v,{onClick:l,sx:{py:.5,px:1},children:[e.jsx(S,{sx:{minWidth:32},children:e.jsx(u,{icon:"solar:pause-bold",width:20,sx:{color:k?"success.main":"warning.main"}})}),e.jsx(U,{primary:k?"Activate User":"Suspend User",sx:{"& .MuiListItemText-primary":{color:"text.secondary",fontSize:"0.875rem"}}})]}),e.jsxs(v,{onClick:p,sx:{py:.5,px:1},children:[e.jsx(S,{sx:{minWidth:32},children:e.jsx(u,{icon:"solar:restart-bold",width:20})}),e.jsx(U,{primary:"Reset Password",sx:{"& .MuiListItemText-primary":{color:"text.secondary",fontSize:"0.875rem"}}})]}),!C&&e.jsxs(v,{onClick:f,sx:{py:.5,px:1},children:[e.jsx(S,{sx:{minWidth:32},children:e.jsx(u,{icon:"solar:letter-bold",width:20})}),e.jsx(U,{primary:"Resend Invite",sx:{"& .MuiListItemText-primary":{color:"text.secondary",fontSize:"0.875rem"}}})]}),e.jsxs(v,{onClick:b,sx:{py:.5,px:1},children:[e.jsx(S,{sx:{minWidth:32},children:e.jsx(u,{icon:"solar:trash-bin-trash-bold",width:20,sx:{color:"error.main"}})}),e.jsx(U,{primary:"Delete User",sx:{"& .MuiListItemText-primary":{color:"text.secondary",fontSize:"0.875rem"}}})]})]})]}),e.jsx(R,{}),e.jsxs(A,{spacing:2,children:[e.jsxs(g,{children:[e.jsx(j,{variant:"caption",color:"text.secondary",children:"Role"}),e.jsx(g,{sx:{mt:.5},children:e.jsx(T,{value:c?.user_metadata?.role??"User",color:c?.user_metadata?.role?.toLowerCase()==="admin"?"error":"default",variant:"outlined"})})]}),e.jsxs(g,{children:[e.jsx(j,{variant:"caption",color:"text.secondary",children:"Status"}),e.jsx(g,{sx:{mt:.5},children:e.jsx(T,{value:C?"Verified":"Unverified",color:C?"success":"warning",variant:"outlined"})})]}),e.jsxs(g,{children:[e.jsx(j,{variant:"caption",color:"text.secondary",children:"Last Sign In"}),e.jsx(j,{variant:"body2",children:c?.last_sign_in_at?V(c.last_sign_in_at):"Never"})]}),e.jsxs(g,{children:[e.jsx(j,{variant:"caption",color:"text.secondary",children:"Created"}),e.jsx(j,{variant:"body2",children:c?.created_at?V(c.created_at):"N/A"})]})]})]})})}const Se=a=>{try{const{supabaseUser:t,profile:n}=a||{};return t?{id:t.id,name:n?.displayName||`${n?.firstName??""} ${n?.lastName??""}`.trim()||t.email?.split("@")[0]||"Unknown",email:t.email??"",emailVerifiedAt:t.email_confirmed_at,lastSignIn:t.last_sign_in_at,createdAt:t.created_at,role:t.user_metadata?.role??"User",isSuspended:t.user_metadata?.banned||!1,supabaseUser:t,profile:n}:(h.warn("Missing supabaseUser in API response:",a),{id:"unknown",name:"Unknown User",email:"",createdAt:new Date().toISOString()})}catch(t){return h.error("Error transforming user data:",t,a),{id:"error",name:"Error Loading User",email:"",createdAt:new Date().toISOString()}}};function Ie(){const{t:a}=M(),t=ae(),n=le(),[d,o]=x.useState(!1),[l,p]=x.useState(!1),[f,b]=x.useState(null),[I,m]=x.useState(!1),[i,c]=x.useState(null),w=re({mutationFn:s=>ne.deleteUser(s),onSuccess:()=>{D.invalidate?.()}}),_=()=>{p(!0)},k=s=>{t.push(`/admin/user-management/users/${s.id}`)},C=s=>{const r={id:s.id,name:s.name,email:s.email,firstName:s.profile?.firstName??"",lastName:s.profile?.lastName??"",role:s.role,active:!!s.emailVerifiedAt};b(r),o(!0)},L=async(s,r)=>{try{r?h.debug("Banning user:",s.id):h.debug("Unbanning user:",s.id)}catch(y){h.error("Error toggling suspend:",y)}},E=async s=>{try{h.debug("Revoking sessions for user:",s)}catch(r){h.error("Error revoking sessions:",r)}},N=async s=>{await n({title:"Delete User",message:`Are you sure you want to delete ${s.name}? This cannot be undone.`,variant:"danger",confirmText:"Delete",cancelText:"Cancel"})&&w.mutate(s.id)},W=[{id:"name",label:a("users.name"),sortable:!0,minWidth:120,maxWidth:250,render:(s,r)=>e.jsx(me,{name:r.name,email:r.email,onClick:()=>{const y={supabaseUser:r.supabaseUser??{id:r.id,email:r.email,email_confirmed_at:r.emailVerifiedAt,last_sign_in_at:r.lastSignIn,created_at:r.createdAt,user_metadata:{role:r.role,banned:r.isSuspended}},profile:r.profile??{}};c(y),m(!0)}})},{id:"role",label:a("users.role"),width:100,sortable:!0,render:(s,r)=>e.jsx(T,{value:r.role??"User",color:r.role?.toLowerCase()==="admin"?"error":"default",variant:"outlined"})},{id:"emailVerifiedAt",label:a("users.status"),width:100,sortable:!0,render:(s,r)=>e.jsx(T,{value:r.emailVerifiedAt?a("users.verified"):a("users.unverified"),color:r.emailVerifiedAt?"success":"warning",variant:"outlined"})},{id:"lastSignIn",label:a("users.lastSignIn"),width:150,sortable:!0,render:(s,r)=>e.jsx(ue,{value:r.lastSignIn})},{id:"isSuspended",label:"Suspended",width:100,sortable:!0,render:(s,r)=>e.jsx(we,{checked:r.isSuspended||!1,onChange:y=>L(r,y)})},{id:"actions",label:"",width:80,minWidth:80,maxWidth:80,render:(s,r)=>{const y=[{id:"view",label:"View Profile",icon:e.jsx(u,{icon:"solar:eye-bold"}),onClick:()=>k(r)},{id:"edit",label:"Edit",icon:e.jsx(u,{icon:"solar:pen-bold"}),onClick:()=>C(r)},{id:"revoke",label:"Revoke Sessions",icon:e.jsx(u,{icon:"solar:power-bold"}),onClick:()=>E(r.id)},{id:"suspend",label:r.isSuspended?"Unsuspend User":"Suspend User",icon:e.jsx(u,{icon:"solar:power-bold"}),onClick:()=>L(r,!r.isSuspended)},{id:"delete",label:"Delete User",icon:e.jsx(u,{icon:"solar:trash-bin-trash-bold"}),onClick:()=>N(r),color:"error"}];return e.jsx(de,{actions:y,moreIcon:e.jsx(u,{icon:"solar:menu-dots-bold"})})}}],O=[{id:"all",label:a("users.all"),filter:s=>s},{id:"verified",label:a("users.verified"),filter:s=>s.filter(r=>r.emailVerifiedAt),color:"success"},{id:"unverified",label:a("users.unverified"),filter:s=>s.filter(r=>!r.emailVerifiedAt),color:"warning"}],z={placeholder:"Search users...",searchFields:["name","email","role"],filterOptions:[{label:"Role",value:"role",options:["Admin","User","Manager"]}]};return e.jsxs(te,{children:[e.jsx(pe,{title:a("users.title"),description:a("users.description"),breadcrumbs:[{label:a("users.breadcrumb.admin")},{label:a("users.breadcrumb.users")}],action:{label:a("users.add"),onClick:_,icon:e.jsx(u,{icon:"mingcute:add-line"})}}),e.jsx(ce,{store:{useQuery:()=>{const s=D.useQuery(ie);return{...s,data:Array.isArray(s.data)?s.data.map(Se):[]}}},columns:W,getRowId:s=>s.id,filterTabs:O,searchConfig:z,onRowSelect:s=>h.debug("Selected:",s),labels:{search:a("dataTable.search"),keyword:a("dataTable.keyword"),clear:a("dataTable.clear"),resultsFound:a("dataTable.resultsFound"),dense:a("dataTable.dense"),rowsPerPage:a("dataTable.rowsPerPage")}}),e.jsx(ve,{open:d,onClose:()=>{o(!1),b(null)},user:f,onSuccess:()=>{D.invalidate?.()}}),e.jsx(ye,{open:l,onClose:()=>p(!1),onSuccess:()=>{D.invalidate?.(),p(!1)}}),e.jsx(Ue,{open:I,onClose:()=>{m(!1),c(null)},user:i,onEdit:()=>{if(i){const s={id:i.supabaseUser.id,name:i.profile?.displayName??(`${i.profile?.firstName??""} ${i.profile?.lastName??""}`.trim()||i.supabaseUser.email?.split("@")[0])??"Unknown",email:i.supabaseUser.email,firstName:i.profile?.firstName??"",lastName:i.profile?.lastName??"",role:i.supabaseUser.user_metadata?.role,active:!!i.supabaseUser.email_confirmed_at};b(s),o(!0),m(!1)}},onViewProfile:()=>{i&&(t.push(`/admin/user-management/users/${i.supabaseUser.id}`),m(!1))},onSuspend:async()=>{if(i){const s=i.supabaseUser.user_metadata?.banned??!1;await L({id:i.supabaseUser.id,isSuspended:s,name:"",email:"",createdAt:""},!s),m(!1)}},onResetPassword:()=>{h.debug("Reset password for user:",i?.supabaseUser.id),m(!1)},onResendInvite:()=>{h.debug("Resend invite for user:",i?.supabaseUser.id),m(!1)},onDelete:async()=>{i&&(await N({id:i.supabaseUser.id,name:i.profile?.displayName??i.supabaseUser.email?.split("@")[0]??"Unknown",email:i.supabaseUser.email,createdAt:i.supabaseUser.created_at}),m(!1))}})]})}function Ee(){return e.jsx(Ie,{})}export{Ee as default};
